version: '3.9'

services:
  # PostgreSQL Database
  db:
    image: postgres:15-alpine
    container_name: backapp-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-backapp}
      POSTGRES_USER: ${POSTGRES_USER:-backapp}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-backapp}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - backapp-network

  # Next.js Application
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: backapp-app
    restart: unless-stopped
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      DATABASE_URL: postgresql://${POSTGRES_USER:-backapp}:${POSTGRES_PASSWORD:-changeme}@db:5432/${POSTGRES_DB:-backapp}
      NEXTAUTH_URL: ${NEXTAUTH_URL:-http://localhost:3000}
      NEXTAUTH_SECRET: ${NEXTAUTH_SECRET}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      AWS_REGION: ${AWS_REGION:-us-east-1}
      AWS_S3_BUCKET: ${AWS_S3_BUCKET}
      AWS_S3_ENDPOINT: ${AWS_S3_ENDPOINT}
      SMTP_HOST: ${SMTP_HOST:-mailhog}
      SMTP_PORT: ${SMTP_PORT:-1025}
      SMTP_USER: ${SMTP_USER}
      SMTP_PASSWORD: ${SMTP_PASSWORD}
      SMTP_FROM: ${SMTP_FROM:-noreply@backapp.local}
    ports:
      - "${APP_PORT:-3000}:3000"
    depends_on:
      db:
        condition: service_healthy
    networks:
      - backapp-network
    volumes:
      - ./logs:/app/logs
      # Mount directories you want to backup
      # Add your local directories here - they'll be accessible inside the container at /backup-sources
      - /Users/davidsells:/backup-sources/davidsells:ro  # ro = read-only for safety

  # LocalStack (S3 Mock for Development)
  localstack:
    image: localstack/localstack:latest
    container_name: backapp-localstack
    restart: unless-stopped
    environment:
      SERVICES: s3
      DEBUG: ${DEBUG:-0}
      DATA_DIR: /tmp/localstack/data
      HOSTNAME_EXTERNAL: localstack
    ports:
      - "4566:4566"
      - "4510-4559:4510-4559"
    volumes:
      - localstack_data:/tmp/localstack
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - backapp-network

  # MailHog (Email Testing)
  mailhog:
    image: mailhog/mailhog:latest
    container_name: backapp-mailhog
    restart: unless-stopped
    ports:
      - "1025:1025"  # SMTP
      - "8025:8025"  # Web UI
    networks:
      - backapp-network

volumes:
  postgres_data:
    driver: local
  localstack_data:
    driver: local

networks:
  backapp-network:
    driver: bridge
